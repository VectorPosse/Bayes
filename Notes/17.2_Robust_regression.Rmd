---
title: "17.2: Robust regression"
output: html_notebook
---


## Introduction

This is code for Section 17.2 of Kruschke using a Student t noise distribution. Other than that change, this document is very similar to the one from section 7.1.

Make sure that the two files "HtWtData30.csv" and "HtWtData300.csv" are in your project directory.


## Preliminaries

Load necessary packages:

```{r}
library(tidyverse)
library(rstan)
library(tidybayes)
library(bayesplot)
```

Set Stan to save compiled code.

```{r}
rstan_options(auto_write = TRUE)
```

Set Stan to use parallel processing where possible.

```{r}
options(mc.cores = parallel::detectCores())
```


## Data

```{r}
HtWtData30 <- read_csv("HtWtData30.csv")
HtWtData30
```

```{r}
ggplot(HtWtData30, aes(y = weight, x = height)) +
    geom_point()
```

```{r}
HtWtData300 <- read_csv("HtWtData300.csv")
HtWtData300
```

```{r}
ggplot(HtWtData300, aes(y = weight, x = height)) +
    geom_point()
```


Mean center the x variable. (Kruschke standardizes both variables using z-scores, but that makes the coefficients of the model harder to interpret.)

```{r}
HtWtData30 <- HtWtData30 %>%
    mutate(height_mc = height - mean(height))
HtWtData30
```

```{r}
ggplot(HtWtData30, aes(y = weight, x = height_mc)) +
    geom_point()
```


```{r}
HtWtData300 <- HtWtData300 %>%
    mutate(height_mc = height - mean(height))
HtWtData300
```

```{r}
ggplot(HtWtData300, aes(y = weight, x = height_mc)) +
    geom_point()
```

We're going to run two different examples, so we'll make two lists.

```{r}
stan_data_30 <- list(N = NROW(HtWtData30),
                     y = HtWtData30$weight,
                     x = HtWtData30$height_mc)
stan_data_300 <- list(N = NROW(HtWtData300),
                      y = HtWtData300$weight,
                      x = HtWtData300$height_mc)
```


## Prior predictive check

### Simulation code

```{stan, output.var = "HtWt_robust_prior", cache = TRUE}
data {
    int<lower = 0> N;
    vector<lower = 0>[N] y;
    vector[N] x;
}
generated quantities {
    real nu;
    real beta0;
    real beta1;
    vector[N] mu;
    real<lower = 0> sigma;
    real y_sim[N];
    
    nu = gamma_rng(2, 0.1);       // default prior for df
    beta0 = normal_rng(150, 25);  // Intercept between 100 and 200
    beta1 = normal_rng(0, 5);    // -10 to 10 lbs per inch
    mu = beta0 + beta1 * x;       // linear model
    sigma = exponential_rng(0.1); // default prior for sigma
    y_sim = student_t_rng(nu, mu, sigma);
}
```

### Simulate data

```{r}
fit_HtWt30_robust_prior <- sampling(HtWt_robust_prior,
                                    data = stan_data_30,
                                    chains = 1,
                                    algorithm = "Fixed_param",
                                    seed = 11111,
                                    refresh = 0)
```

### Extract samples

```{r}
samples_HtWt30_prior <- tidy_draws(fit_HtWt30_robust_prior)
samples_HtWt30_prior
```

```{r}
y_sim_prior <- samples_HtWt30_prior %>%
    select(starts_with("y_sim")) %>%
    as.matrix()
```

### Plot results

```{r}
ggplot(HtWtData30, aes(y = weight, x = height_mc)) +
    geom_point() +
    geom_abline(data = samples_HtWt30_prior,
                aes(intercept = beta0, slope = beta1),
                alpha = 0.05)
```

```{r}
mcmc_hist(samples_HtWt30_prior,
          pars = c("nu", "sigma", "beta0", "beta1"))
```



```{r}
ppc_intervals(y = HtWtData30$weight,
              x = HtWtData30$height,
              yrep = y_sim_prior)
```


## Model

```{stan, output.var = "HtWt_robust", cache = TRUE}
data {
    int<lower = 0> N;
    vector<lower = 0>[N] y;
    vector[N] x;
}
parameters {
    real nu;
    real beta0;
    real beta1;
    real<lower = 0> sigma;
}
transformed parameters {
    vector[N] mu;
    mu = beta0 + beta1 * x;   // linear model
}
model {
    nu ~ gamma(2, 0.1);       // default prior for df
    beta0 ~ normal(150, 25);  // Intercept between 100 and 200
    beta1 ~ normal(0, 5);    // -10 to 10 lbs per inch
    sigma ~ exponential(0.1); // default prior for sigma
    y ~ student_t(nu, mu, sigma);
}
generated quantities {
    real y_sim[N];
    y_sim = student_t_rng(nu, mu, sigma);
}
```

```{r}
fit_HtWt30_robust <- sampling(HtWt_robust,
                              data = stan_data_30,
                              seed = 11111,
                              refresh = 0)
```


## Diagnosing the model

```{r}
plot(fit_HtWt30_robust, plotfun = "ac",
     pars = c("nu", "beta0", "beta1", "sigma"))
```

```{r}
plot(fit_HtWt30_robust, plotfun = "trace",
     pars = c("nu", "beta0", "beta1", "sigma"))
```


## Summarizing the model

```{r}
print(fit_HtWt30_robust, pars = c("nu", "beta0", "beta1", "sigma"))
```


## Visualizing the model

```{r}
pairs(fit_HtWt30_robust,
      pars = c("nu", "beta0", "beta1", "sigma"))
```

```{r}
stan_dens(fit_HtWt30_robust,
     pars = c("nu", "beta0", "beta1", "sigma"))
```

```{r}
plot(fit_HtWt30_robust,
     pars = c("nu", "beta0", "beta1", "sigma"))
```


## The model with 300 observations

```{r}
fit_HtWt300_robust <- sampling(HtWt_robust,
                               data = stan_data_300,
                               seed = 11111,
                               refresh = 0)
```

```{r}
plot(fit_HtWt300_robust, plotfun = "ac",
     pars = c("nu", "beta0", "beta1", "sigma"))
```

```{r}
plot(fit_HtWt300_robust, plotfun = "trace",
     pars = c("nu", "beta0", "beta1", "sigma"))
```

```{r}
print(fit_HtWt300_robust,
      pars = c("nu", "beta0", "beta1", "sigma"))
```

```{r}
pairs(fit_HtWt300_robust,
      pars = c("nu", "beta0", "beta1", "sigma"))
```

```{r}
plot(fit_HtWt300_robust, plotfun = "dens",
     pars = c("nu", "beta0", "beta1", "sigma"))
```

```{r}
plot(fit_HtWt300_robust,
     pars = c("nu", "beta0", "beta1", "sigma"))
```


## Posterior predictive check

We'll just do this for the example with 30 observations.

### Extract samples

```{r}
samples_HtWt30 <- tidy_draws(fit_HtWt30_robust)
samples_HtWt30
```

```{r}
y_sim_post <- samples_HtWt30 %>%
    select(starts_with("y_sim")) %>%
    as.matrix()
```

### Plot results

```{r}
ggplot(HtWtData30, aes(y = weight, x = height_mc)) +
    geom_point() +
    geom_abline(data = samples_HtWt30,
                aes(intercept = beta0, slope = beta1),
                alpha = 0.01) +
    geom_abline(data = samples_HtWt30,
                aes(intercept = mean(beta0), slope = mean(beta1)),
                color = "blue", size = 2)
```

Compare to standard linear regression.

```{r}
ggplot(HtWtData30, aes(y = weight, x = height_mc)) +
    geom_point() +
    geom_abline(data = samples_HtWt30,
                aes(intercept = beta0, slope = beta1),
                alpha = 0.01) +
    geom_abline(data = samples_HtWt30,
                aes(intercept = mean(beta0), slope = mean(beta1)),
                color = "blue", size = 2) +
    geom_smooth(method = lm, color = "red", size = 2)
```

```{r}
ppc_intervals(y = HtWtData30$weight,
              x = HtWtData30$height,
              yrep = y_sim_post)
```

```{r}
ppc_hist(y, y_sim_post[1:5, ])
```

```{r}
ppc_boxplot(y, y_sim[1:5, ])
```

```{r}
ppc_dens(y, y_sim[1:5, ])
```

```{r}
ppc_dens_overlay(y, y_sim[1:30, ])
```

```{r}
ppc_stat_2d(y, y_sim)
```